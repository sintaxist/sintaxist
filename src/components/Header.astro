---
import * as Icons from "@/components/ui/Icons.ts";
import LangSwitcher from "@/components/LangSwitcher.astro";
import LogoHeader from "@/components/ui/LogoHeader.astro";

const { t, sections } = Astro.props;

const menuItems = [
  { id: "home", label: sections.home },
  { id: "aboutMe", label: sections.aboutMe },
  { id: "projects", label: sections.projects },
  { id: "experience", label: sections.experience },
  { id: "skills", label: sections.skills },
  { id: "contact", label: sections.contact },
];
---

<header
  id="main-header"
  class="fixed top-0 left-0 right-0 z-51 transition-all duration-500 py-2 md:py-4"
  data-section-theme="light"
>
  <div class="max-w-7xl mx-auto py-4 px-6">
    <div class="flex items-center justify-between">
      <a
        href="/"
        id="logo-link"
        aria-label={t.textLogoAriaLabel}
        title="Volver al inicio"
        class="text-primary hover:text-primary-hover transition-colors duration-300"
      >
        <LogoHeader class="h-10" />
      </a>

      <nav
        id="desktop-nav"
        class="hidden md:flex items-center justify-center gap-x-4 lg:gap-x-8 relative"
      >
        {
          menuItems.map((item) => (
            <a
              href={`#${item.id}`}
              class="font-secondary nav-link text-xs lg:text-md text-primary transition-colors duration-300 tracking-wide py-2"
              data-nav-link={item.id}
            >
              {item.label}
            </a>
          ))
        }
        <div id="nav-underline" class="nav-underline"></div>
      </nav>

      <LangSwitcher class="hidden md:block m-auto md:m-0" />

      <button
        id="mobile-menu-btn"
        class="cursor-pointer md:hidden p-2 rounded-md text-primary hover:bg-primary-light transition-colors duration-300 z-50"
      >
        <span id="menu-icon" class="w-7 h-7 flex items-center justify-center">
          <Fragment set:html={Icons.Menu} />
          <span class="sr-only">Men√∫</span>
        </span>
        <span
          id="close-icon"
          class="w-7 h-7 items-center justify-center hidden"
        >
          <Fragment set:html={Icons.X} />
          <span class="sr-only">Cerrar</span>
        </span>
      </button>
    </div>
  </div>
</header>
<div
  id="mobile-nav-panel"
  class="mobile-nav-panel md:hidden fixed pt-[80px] right-0 w-full h-full bg-secondary z-50"
>
  <nav class="flex flex-col gap-4 space-y-2 flex-1 p-6 h-full">
    {
      menuItems.map((item) => (
        <a
          href={`#${item.id}`}
          class="nav-link mobile-nav-link text-center w-full rounded-lg p-4 font-bold transition duration-300 text-md font-secondary"
          data-nav-link={item.id}
        >
          {item.label}
        </a>
      ))
    }
    <LangSwitcher class="mx-auto" />
  </nav>
</div>

<script>
  function smoothScroll(target) {
    const start = window.scrollY;
    const end = target.getBoundingClientRect().top + window.scrollY - 150;
    const duration = 50;
    let startTime = null;

    function easeInOutQuad(t) {
      return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
    }

    function animation(currentTime) {
      if (startTime === null) startTime = currentTime;
      const timeElapsed = currentTime - startTime;
      const progress = Math.min(timeElapsed / duration, 1);
      const run = start + (end - start) * easeInOutQuad(progress);
      window.scrollTo(0, run);
      if (timeElapsed < duration) {
        requestAnimationFrame(animation);
      }
    }
    requestAnimationFrame(animation);
  }

  document.addEventListener("astro:page-load", () => {
    
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    const header = document.getElementById("main-header");
    const mobileMenuBtn = document.getElementById("mobile-menu-btn");
    const allScrollLinks = document.querySelectorAll("a[href^='#']");

    function getElement(id) {
      const el = document.getElementById(id);
      if (!el) {
        return null;
      }
      return el;
    }

    const mobileNavPanel = getElement("mobile-nav-panel");
    const menuIcon = getElement("menu-icon");
    const closeIcon = getElement("close-icon");
    const desktopNavLinks = document.querySelectorAll("#desktop-nav a.nav-link");
    const mobileNavLinks = document.querySelectorAll(".mobile-nav-panel a.nav-link");
    const navUnderline = getElement("nav-underline");
    const sections = document.querySelectorAll("section[id]");

    if (!header || !mobileMenuBtn || !mobileNavPanel || !menuIcon || !closeIcon || !navUnderline) {
      return;
    }

    const scrolledClasses = ['bg-secondary', 'shadow-lg', 'shadow-black/5'];
    const handleScroll = () => {
      if (window.scrollY > 50) {
        header.classList.add(...scrolledClasses);
      } else {
        header.classList.remove(...scrolledClasses);
      }
    };
    window.addEventListener("scroll", handleScroll, { passive: true });
    handleScroll();

    function closeMobileMenu() {
      if (mobileNavPanel && menuIcon && closeIcon) {
        mobileNavPanel.classList.remove("is-open");
        menuIcon.classList.remove("hidden");
        closeIcon.classList.add("hidden");
        document.body.style.overflow = "";
      }
    }

    mobileMenuBtn.addEventListener("click", () => {
      const isOpen = mobileNavPanel.classList.toggle("is-open");
      menuIcon.classList.toggle("hidden", isOpen);
      closeIcon.classList.toggle("hidden", !isOpen);
      closeIcon.classList.add("flex");
      document.body.style.overflow = isOpen ? "hidden" : "";
      if (isOpen) {
        header.classList.remove(...scrolledClasses);
      } else {
        handleScroll();
      }
    });

    allScrollLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        const href = link.getAttribute("href");
        if (!href || href === '#') return;
        
        const targetId = href.substring(1);
        const targetEl = document.getElementById(targetId);

        if (targetEl) {
          e.preventDefault();
          closeMobileMenu();
          smoothScroll(targetEl);
        } 
        else {
          e.preventDefault();
          const langPrefix = window.location.pathname.split('/')[1] || 'es';
          window.location.href = `/${langPrefix}/#${targetId}`;
        }
      });
    });

    function updateUnderline(activeLink) {
      if (!activeLink) {
        navUnderline.style.width = "0";
        return;
      }
      const navRect = navUnderline.parentElement.getBoundingClientRect();
      const linkRect = activeLink.getBoundingClientRect();
      const left = linkRect.left - navRect.left;
      requestAnimationFrame(() => {
        navUnderline.style.left = `${left}px`;
        navUnderline.style.width = `${linkRect.width}px`;
      });
    }

    function setActiveLink(sectionId) {
      let activeDesktopLink = null;
      desktopNavLinks.forEach((link) => {
        const isTarget = link.getAttribute("data-nav-link") === sectionId;
        link.classList.toggle("is-active", isTarget);
        if (isTarget) activeDesktopLink = link;
      });
      mobileNavLinks.forEach((link) => {
        link.classList.toggle("is-active", link.getAttribute("data-nav-link") === sectionId);
      });
      updateUnderline(activeDesktopLink);
    }

    if (sections.length > 0) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const sectionId = entry.target.getAttribute("id");
              if (sectionId) setActiveLink(sectionId);
            }
          });
        },
        { rootMargin: "-40% 0px -40% 0px" }
      );
      sections.forEach((section) => observer.observe(section));
    }

    const navigationEntry = performance.getEntriesByType("navigation")[0] as PerformanceNavigationTiming;
    if (navigationEntry && navigationEntry.type !== 'back_forward' && window.location.hash) {
      const targetId = window.location.hash.substring(1);
      const targetEl = document.getElementById(targetId);
      if (targetEl) {
        setTimeout(() => {
          smoothScroll(targetEl);
          history.replaceState(null, "", window.location.pathname);
        }, 100);
      }
    }
  });
</script>

<style>
  :root {
    --color-glass-bg: rgba(228, 226, 210, 0.6);
  }

  a.nav-link.is-active {
    color: var(--color-primary);
  }

  a.nav-link:hover {
    color: var(--color-primary-hover);
  }

  .nav-underline {
    position: absolute;
    bottom: 0;
    height: 2px;
    background-color: var(--color-primary-hover);
    border-radius: 1px;
    transition:
      left 0.3s ease-in-out,
      width 0.3s ease-in-out;
  }

  .mobile-nav-panel {
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
  }

  .mobile-nav-panel.is-open {
    transform: translateX(0);
  }

  .mobile-nav-link {
    color: var(--color-primary);
  }

  .mobile-nav-link:hover,
  .mobile-nav-link.is-active {
    color: var(--color-primary-hover);
    background-color: var(--color-primary-light);
  }
</style>
